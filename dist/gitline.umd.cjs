(function(T,L){typeof exports=="object"&&typeof module<"u"?module.exports=L():typeof define=="function"&&define.amd?define(L):(T=typeof globalThis<"u"?globalThis:T||self,T["@piotrpdev/gitline"]=L())})(this,function(){"use strict";var wt=Object.defineProperty;var bt=(T,L,H)=>L in T?wt(T,L,{enumerable:!0,configurable:!0,writable:!0,value:H}):T[L]=H;var s=(T,L,H)=>(bt(T,typeof L!="symbol"?L+"":L,H),H);class T{constructor(t,e,i,n,m){s(this,"label");s(this,"data");s(this,"callback");s(this,"index");s(this,"of");this.label=t,this.data=e,this.callback=i,this.index=n,this.of=m}}class L{constructor(t){s(this,"element");s(this,"items",[]);s(this,"suspended",!1);this.element=t}then(t,e,i){return this.thenSingle(t,()=>{for(var n=e(),m=n.length-1;m>=0;m--)this.items.unshift(new T(t,n[m],i,m,n.length))}),this}thenSingle(t,e){return this.items.push(new T(t,null,e,0,1)),this}start(t=!0){t&&(this.element.hidden=!1),this.next()}next(){var t=this.items.shift();t!==void 0?t.index%50===0?(this.showStatus(t),window.setTimeout(()=>{console.debug("executing "+t.label+" ("+t.index+"/"+t.of+")"),this.execute(t)},0)):this.execute(t):this.element.hidden=!0}suspend(){this.suspended=!0}resume(){this.suspended=!1,this.next()}showStatus(t){this.element.innerHTML=t.label}execute(t){try{t.callback(t.data),this.suspended||this.next()}catch(e){this.error(e)}}error(t){console.error(t),this.element.innerHTML=t,this.suspend()}}class H{constructor(t,e,i){s(this,"specifity");s(this,"start");s(this,"origin");s(this,"category");s(this,"commit");s(this,"ref");s(this,"shortname");s(this,"lane");s(this,"parent");s(this,"anonymous");this.ref=t,this.commit=e,this.specifity=i,this.shortname=t.split("@")[0],this.category=this.shortname.substring(0,this.shortname.lastIndexOf("/"))}}var M=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function rt(w){return w&&w.__esModule&&Object.prototype.hasOwnProperty.call(w,"default")?w.default:w}function nt(w){if(w.__esModule)return w;var t=w.default;if(typeof t=="function"){var e=function i(){return this instanceof i?Reflect.construct(t,arguments,this.constructor):t.apply(this,arguments)};e.prototype=t.prototype}else e={};return Object.defineProperty(e,"__esModule",{value:!0}),Object.keys(w).forEach(function(i){var n=Object.getOwnPropertyDescriptor(w,i);Object.defineProperty(e,i,n.get?n:{enumerable:!0,get:function(){return w[i]}})}),e}var Z={exports:{}};function st(w){throw new Error('Could not dynamically require "'+w+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var U={exports:{}};const at=nt(Object.freeze(Object.defineProperty({__proto__:null,default:{}},Symbol.toStringTag,{value:"Module"})));var Q;function ot(){return Q||(Q=1,function(w,t){(function(e,i){w.exports=i()})(M,function(){var e=e||function(i,n){var m;if(typeof window<"u"&&window.crypto&&(m=window.crypto),typeof self<"u"&&self.crypto&&(m=self.crypto),typeof globalThis<"u"&&globalThis.crypto&&(m=globalThis.crypto),!m&&typeof window<"u"&&window.msCrypto&&(m=window.msCrypto),!m&&typeof M<"u"&&M.crypto&&(m=M.crypto),!m&&typeof st=="function")try{m=at}catch{}var C=function(){if(m){if(typeof m.getRandomValues=="function")try{return m.getRandomValues(new Uint32Array(1))[0]}catch{}if(typeof m.randomBytes=="function")try{return m.randomBytes(4).readInt32LE()}catch{}}throw new Error("Native crypto module could not be used to get secure random number.")},S=Object.create||function(){function r(){}return function(d){var u;return r.prototype=d,u=new r,r.prototype=null,u}}(),D={},l=D.lib={},k=l.Base=function(){return{extend:function(r){var d=S(this);return r&&d.mixIn(r),(!d.hasOwnProperty("init")||this.init===d.init)&&(d.init=function(){d.$super.init.apply(this,arguments)}),d.init.prototype=d,d.$super=this,d},create:function(){var r=this.extend();return r.init.apply(r,arguments),r},init:function(){},mixIn:function(r){for(var d in r)r.hasOwnProperty(d)&&(this[d]=r[d]);r.hasOwnProperty("toString")&&(this.toString=r.toString)},clone:function(){return this.init.prototype.extend(this)}}}(),x=l.WordArray=k.extend({init:function(r,d){r=this.words=r||[],d!=n?this.sigBytes=d:this.sigBytes=r.length*4},toString:function(r){return(r||P).stringify(this)},concat:function(r){var d=this.words,u=r.words,g=this.sigBytes,v=r.sigBytes;if(this.clamp(),g%4)for(var y=0;y<v;y++){var R=u[y>>>2]>>>24-y%4*8&255;d[g+y>>>2]|=R<<24-(g+y)%4*8}else for(var E=0;E<v;E+=4)d[g+E>>>2]=u[E>>>2];return this.sigBytes+=v,this},clamp:function(){var r=this.words,d=this.sigBytes;r[d>>>2]&=4294967295<<32-d%4*8,r.length=i.ceil(d/4)},clone:function(){var r=k.clone.call(this);return r.words=this.words.slice(0),r},random:function(r){for(var d=[],u=0;u<r;u+=4)d.push(C());return new x.init(d,r)}}),b=D.enc={},P=b.Hex={stringify:function(r){for(var d=r.words,u=r.sigBytes,g=[],v=0;v<u;v++){var y=d[v>>>2]>>>24-v%4*8&255;g.push((y>>>4).toString(16)),g.push((y&15).toString(16))}return g.join("")},parse:function(r){for(var d=r.length,u=[],g=0;g<d;g+=2)u[g>>>3]|=parseInt(r.substr(g,2),16)<<24-g%8*4;return new x.init(u,d/2)}},_=b.Latin1={stringify:function(r){for(var d=r.words,u=r.sigBytes,g=[],v=0;v<u;v++){var y=d[v>>>2]>>>24-v%4*8&255;g.push(String.fromCharCode(y))}return g.join("")},parse:function(r){for(var d=r.length,u=[],g=0;g<d;g++)u[g>>>2]|=(r.charCodeAt(g)&255)<<24-g%4*8;return new x.init(u,d)}},f=b.Utf8={stringify:function(r){try{return decodeURIComponent(escape(_.stringify(r)))}catch{throw new Error("Malformed UTF-8 data")}},parse:function(r){return _.parse(unescape(encodeURIComponent(r)))}},p=l.BufferedBlockAlgorithm=k.extend({reset:function(){this._data=new x.init,this._nDataBytes=0},_append:function(r){typeof r=="string"&&(r=f.parse(r)),this._data.concat(r),this._nDataBytes+=r.sigBytes},_process:function(r){var d,u=this._data,g=u.words,v=u.sigBytes,y=this.blockSize,R=y*4,E=v/R;r?E=i.ceil(E):E=i.max((E|0)-this._minBufferSize,0);var O=E*y,I=i.min(O*4,v);if(O){for(var Y=0;Y<O;Y+=y)this._doProcessBlock(g,Y);d=g.splice(0,O),u.sigBytes-=I}return new x.init(d,I)},clone:function(){var r=k.clone.call(this);return r._data=this._data.clone(),r},_minBufferSize:0});l.Hasher=p.extend({cfg:k.extend(),init:function(r){this.cfg=this.cfg.extend(r),this.reset()},reset:function(){p.reset.call(this),this._doReset()},update:function(r){return this._append(r),this._process(),this},finalize:function(r){r&&this._append(r);var d=this._doFinalize();return d},blockSize:16,_createHelper:function(r){return function(d,u){return new r.init(u).finalize(d)}},_createHmacHelper:function(r){return function(d,u){return new B.HMAC.init(r,u).finalize(d)}}});var B=D.algo={};return D}(Math);return e})}(U)),U.exports}(function(w,t){(function(e,i){w.exports=i(ot())})(M,function(e){return function(i){var n=e,m=n.lib,C=m.WordArray,S=m.Hasher,D=n.algo,l=[];(function(){for(var f=0;f<64;f++)l[f]=i.abs(i.sin(f+1))*4294967296|0})();var k=D.MD5=S.extend({_doReset:function(){this._hash=new C.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(f,p){for(var B=0;B<16;B++){var r=p+B,d=f[r];f[r]=(d<<8|d>>>24)&16711935|(d<<24|d>>>8)&4278255360}var u=this._hash.words,g=f[p+0],v=f[p+1],y=f[p+2],R=f[p+3],E=f[p+4],O=f[p+5],I=f[p+6],Y=f[p+7],A=f[p+8],z=f[p+9],F=f[p+10],W=f[p+11],q=f[p+12],G=f[p+13],J=f[p+14],N=f[p+15],a=u[0],o=u[1],h=u[2],c=u[3];a=x(a,o,h,c,g,7,l[0]),c=x(c,a,o,h,v,12,l[1]),h=x(h,c,a,o,y,17,l[2]),o=x(o,h,c,a,R,22,l[3]),a=x(a,o,h,c,E,7,l[4]),c=x(c,a,o,h,O,12,l[5]),h=x(h,c,a,o,I,17,l[6]),o=x(o,h,c,a,Y,22,l[7]),a=x(a,o,h,c,A,7,l[8]),c=x(c,a,o,h,z,12,l[9]),h=x(h,c,a,o,F,17,l[10]),o=x(o,h,c,a,W,22,l[11]),a=x(a,o,h,c,q,7,l[12]),c=x(c,a,o,h,G,12,l[13]),h=x(h,c,a,o,J,17,l[14]),o=x(o,h,c,a,N,22,l[15]),a=b(a,o,h,c,v,5,l[16]),c=b(c,a,o,h,I,9,l[17]),h=b(h,c,a,o,W,14,l[18]),o=b(o,h,c,a,g,20,l[19]),a=b(a,o,h,c,O,5,l[20]),c=b(c,a,o,h,F,9,l[21]),h=b(h,c,a,o,N,14,l[22]),o=b(o,h,c,a,E,20,l[23]),a=b(a,o,h,c,z,5,l[24]),c=b(c,a,o,h,J,9,l[25]),h=b(h,c,a,o,R,14,l[26]),o=b(o,h,c,a,A,20,l[27]),a=b(a,o,h,c,G,5,l[28]),c=b(c,a,o,h,y,9,l[29]),h=b(h,c,a,o,Y,14,l[30]),o=b(o,h,c,a,q,20,l[31]),a=P(a,o,h,c,O,4,l[32]),c=P(c,a,o,h,A,11,l[33]),h=P(h,c,a,o,W,16,l[34]),o=P(o,h,c,a,J,23,l[35]),a=P(a,o,h,c,v,4,l[36]),c=P(c,a,o,h,E,11,l[37]),h=P(h,c,a,o,Y,16,l[38]),o=P(o,h,c,a,F,23,l[39]),a=P(a,o,h,c,G,4,l[40]),c=P(c,a,o,h,g,11,l[41]),h=P(h,c,a,o,R,16,l[42]),o=P(o,h,c,a,I,23,l[43]),a=P(a,o,h,c,z,4,l[44]),c=P(c,a,o,h,q,11,l[45]),h=P(h,c,a,o,N,16,l[46]),o=P(o,h,c,a,y,23,l[47]),a=_(a,o,h,c,g,6,l[48]),c=_(c,a,o,h,Y,10,l[49]),h=_(h,c,a,o,J,15,l[50]),o=_(o,h,c,a,O,21,l[51]),a=_(a,o,h,c,q,6,l[52]),c=_(c,a,o,h,R,10,l[53]),h=_(h,c,a,o,F,15,l[54]),o=_(o,h,c,a,v,21,l[55]),a=_(a,o,h,c,A,6,l[56]),c=_(c,a,o,h,N,10,l[57]),h=_(h,c,a,o,I,15,l[58]),o=_(o,h,c,a,G,21,l[59]),a=_(a,o,h,c,E,6,l[60]),c=_(c,a,o,h,W,10,l[61]),h=_(h,c,a,o,y,15,l[62]),o=_(o,h,c,a,z,21,l[63]),u[0]=u[0]+a|0,u[1]=u[1]+o|0,u[2]=u[2]+h|0,u[3]=u[3]+c|0},_doFinalize:function(){var f=this._data,p=f.words,B=this._nDataBytes*8,r=f.sigBytes*8;p[r>>>5]|=128<<24-r%32;var d=i.floor(B/4294967296),u=B;p[(r+64>>>9<<4)+15]=(d<<8|d>>>24)&16711935|(d<<24|d>>>8)&4278255360,p[(r+64>>>9<<4)+14]=(u<<8|u>>>24)&16711935|(u<<24|u>>>8)&4278255360,f.sigBytes=(p.length+1)*4,this._process();for(var g=this._hash,v=g.words,y=0;y<4;y++){var R=v[y];v[y]=(R<<8|R>>>24)&16711935|(R<<24|R>>>8)&4278255360}return g},clone:function(){var f=S.clone.call(this);return f._hash=this._hash.clone(),f}});function x(f,p,B,r,d,u,g){var v=f+(p&B|~p&r)+d+g;return(v<<u|v>>>32-u)+p}function b(f,p,B,r,d,u,g){var v=f+(p&r|B&~r)+d+g;return(v<<u|v>>>32-u)+p}function P(f,p,B,r,d,u,g){var v=f+(p^B^r)+d+g;return(v<<u|v>>>32-u)+p}function _(f,p,B,r,d,u,g){var v=f+(B^(p|~r))+d+g;return(v<<u|v>>>32-u)+p}n.MD5=S._createHelper(k),n.HmacMD5=S._createHmacHelper(k)}(Math),e.MD5})})(Z);var ht=Z.exports;const ct=rt(ht);function X(w){return w*20+12}class lt{constructor(){s(this,"dotHeight",6);s(this,"dotWidth",8);s(this,"remoteOnly",!1);s(this,"avatars",[this.avatar_gravatar])}avatar_gravatar(t){return"http://www.gravatar.com/avatar/"+ct(t.toLowerCase())+"?s=20&d=mm"}}class tt{constructor(t,e,i){s(this,"image");this.name=t,this.email=e,this.date=i}}class ${constructor(t,e){s(this,"container");s(this,"warnings",[]);s(this,"inHeadsRef",[]);s(this,"parents",[]);s(this,"childs",[]);s(this,"siblings",[]);s(this,"outOfScope",!1);s(this,"merges",{standard:[],anonymous:[]});s(this,"sha");s(this,"ssha");s(this,"subject");s(this,"data");s(this,"indexY");s(this,"maxSpecifity");s(this,"branch");s(this,"directparent");s(this,"directchild");s(this,"view");s(this,"committer");s(this,"author");this.container=t,this.data=e,this.data.obj=this,e.inHeads==null&&(e.inHeads=[]),e.parenthashes==null&&(e.parenthashes=[]),e.refnames==null&&(e.refnames=[]),this.sha=e.sha,this.ssha=e.ssha,this.subject=e.subject,this.indexY=t.maxIndexY++,this.committer=new tt(this.data.committername,this.data.committeremail,new Date(this.data.committerdate*1e3)),this.author=new tt(this.data.authorname,this.data.authoremail,new Date(this.data.authordate*1e3))}getShortSha(){return this.ssha}getFullSha(){return this.sha}initRelations(){var t=this;this.data.parenthashes.forEach(e=>{var i=this.container.commits[e];if(i==null&&(i=new $(this.container,{sha:e+Math.random()}),i.outOfScope=!0,t.container.addCommit(i)),this.parents.push(i),i.childs.push(this),this.siblings=i.childs,this.parents.length>0){var n=this.parents[0];this.directparent=n,n.directchild=this}}),this.data.inHeads.forEach(e=>{var i=this.container.commits[e];this.inHeadsRef.indexOf(i)===void 0&&this.inHeadsRef.push(i)})}initDefaultBranch(){for(var t=this;t!=null;)(t.branch==null||t.branch.specifity>this.branch.specifity)&&(t.branch=this.branch),t.branch.start=t,t.branch.origin=t.directparent,t=t.directparent}initHeadSpecifity(){for(var t=0;t<this.data.refnames.length;t++){var e=this.data.refnames[t];if(!this.container.config.remoteOnly||e.indexOf("origin/")==0){this.container.config.remoteOnly&&(e=e.replace(/^origin./,""));var i=e.replace(/[^\/-]/g,"").length*1e3;i+=e.replace(/[^a-zA-Z0-9-]/,"").length,this.container.addBranch(e,this,i),(this.maxSpecifity==null||i<this.maxSpecifity)&&(console.debug("assigning branch",e,this.sha,this.maxSpecifity,i),this.maxSpecifity=i,this.branch=this.container.headsMap[e]),this.initDefaultBranch()}}}initMerges(){if(this.merges={standard:[],anonymous:[]},this.warnings=[],this.parents.length==1){var t=this.parents[0];this.directparent=t,t.directchild=this}if(this.parents.length>=2){var t=this.parents[0];this.directparent=t,t.directchild=this;for(var e=1;e<this.parents.length;e++){var i=this.parents[e];i!=null&&(i.data.refnames.length>0||i.inHeadsRef.length!=t.inHeadsRef.length?this.merges.standard.push({source:i}):(this.merges.anonymous.push({source:i}),this.initAnonymous()))}}}initAnonymous(){this.merges.anonymous.forEach(t=>{for(var e=t.source,i=this;i!=null&&i.branch==null;)i=i.directchild;i!=null&&e.branch==null&&(e.branch=new H(i.branch.ref+"/anonymous"+e.sha+Math.random(),e,i.branch.specifity+1),e.branch.anonymous=!0,e.branch.parent=i.branch,e.branch.start=i,e.branch.category=i.branch.category,this.container.headsMap[e.branch.ref]=e.branch)})}getColor(t){if(this.branch==null)this.warn("No Branch set");else{var e=this.branch;this.branch.anonymous&&(e=this.branch.parent);var i=e.lane*300/this.container.maxX;return"hsl("+i+", 100%, "+t+"%)"}}hasMerges(){return this.merges.standard.length>0||this.merges.anonymous.length>0}getX(){return X(this.getLane())}getY(){return this.outOfScope?this.container.rootLabel.offsetTop+20:this.view.label.offsetTop-this.container.firstCommit.view.label.offsetTop+this.view.label.offsetHeight/2}getOriginIndexY(){return this.branch.origin!=null?this.branch.origin.getIndexY():this.branch.start.outOfScope?this.container.maxIndexY:this.branch.start.indexY}getTipPlusIndexY(){if(this.branch!=null&&this.branch.commit!=null){var t=this.branch.commit.indexY;return this.branch.commit.childs.forEach(e=>{t=Math.min(t,e.indexY)}),t}return 0}intersects(t){return this.outOfScope||t.outOfScope?!0:this.getOriginIndexY()>t.getTipPlusIndexY()&&this.getTipPlusIndexY()<t.getOriginIndexY()}getIndexY(){return this.indexY}warn(t){this.warnings.push(t),this.debug(t)}debug(t){console&&console.debug(t,this)}getLane(){return this.branch!=null?this.branch.commit.branch.lane:null}}class et{constructor(t,e){s(this,"element");s(this,"renderedTo");s(this,"canvas");s(this,"dependencies",[]);this.canvas=t,this.element=e}addIfMissing(){this.element!==void 0&&this.renderedTo==null&&(this.addElements(),this.renderedTo=this.canvas)}addElements(){this.canvas.addElement(this.element)}update(){this.dependencies.forEach(t=>{t.update()})}dependsOn(t){t.dependencies.push(this)}}class V extends et{constructor(e,i){super(e,i);s(this,"parentDot");s(this,"childDot");s(this,"lineColor")}from(e){return this.dependsOn(e),this.parentDot=e,this}to(e){return this.childDot=e,this}color(e){return this.element.getStroke().setWeight(1),this.element.getStroke().setColor(e),this.lineColor=e,this.addIfMissing(),this}}class dt extends V{constructor(e){super(e,e.createLine());s(this,"secondLine");this.secondLine=e.createLine()}addElements(){super.addElements(),this.canvas.addElement(this.secondLine)}update(){super.update(),this.parentDot.x<this.childDot.x?this.element.setStartPointXY(this.parentDot.x+this.parentDot.width/2,this.parentDot.y):this.element.setStartPointXY(this.parentDot.x-this.parentDot.width/2,this.parentDot.y),this.element.setEndPointXY(this.childDot.x,this.parentDot.y),this.element.getStroke().setWeight(1),this.element.getStroke().setDashStyle(jsgl.DashStyles.DASH),this.element.getStroke().setColor(this.lineColor),this.secondLine.setStartPointXY(this.childDot.x,this.parentDot.y),this.secondLine.setEndPointXY(this.childDot.x,this.childDot.y+this.childDot.height/2),this.secondLine.getStroke().setWeight(1),this.secondLine.getStroke().setColor(this.lineColor)}}class ut extends V{constructor(e){super(e,e.createCurve());s(this,"arrow");this.arrow=this.canvas.createPolygon()}addElements(){super.addElements(),this.canvas.addElement(this.arrow)}update(){var e=this.childDot.x,i=this.childDot.y,n=this.parentDot.x,m=this.parentDot.y,C=this.lineColor,S=e<n?1:-1;this.element.setStartPointXY(n,m-this.parentDot.height/2),this.element.setEndPointXY(e+this.childDot.width/2*S,i),this.element.setControl2PointXY(n,i),this.element.setControl1PointXY(n,i),this.element.getStroke().setWeight(1),this.element.getStroke().setColor(C),this.arrow.getStroke().setWeight(0),this.arrow.getFill().setColor(C),this.arrow.clearPoints(),this.arrow.addPointXY(0,0),this.arrow.addPointXY(6,-4),this.arrow.addPointXY(6,4);for(var D=0;D<this.arrow.getPointsCount();D++){var l=this.arrow.getPointAt(D).X,k=this.arrow.getPointAt(D).Y;this.arrow.setPointXYAt(l*S+e+this.childDot.width/2*S,k+i,D)}}}class ft extends et{constructor(e){super(e,e.createRectangle());s(this,"x");s(this,"y");s(this,"width");s(this,"height")}size(e,i){return this.width=e,this.height=i,this.element.setWidth(e),this.element.setHeight(i),this.element.setXRadius(e/4),this.element.setYRadius(e/4),this.update(),this.addIfMissing(),this}at(e,i){return this.x=e,this.y=i,this.update(),this.addIfMissing(),this}color(e,i){return this.element.getStroke().setWeight(1),this.element.getStroke().setColor(e),this.element.getFill().setColor(i),this}update(){this.element.setLocationXY(this.x-this.width/2,this.y-this.height/2),super.update()}}class mt extends V{constructor(t){super(t,t.createLine())}update(){super.update(),this.element.setStartPointXY(this.parentDot.x,this.parentDot.y-this.parentDot.height/2),this.element.setEndPointXY(this.childDot.x,this.childDot.y+this.childDot.height/2)}}class pt{constructor(t,e,i){s(this,"commit");s(this,"label");s(this,"canvas");s(this,"config");s(this,"dot");s(this,"lines",[]);this.canvas=t,this.config=e,this.commit=i,this.dot=new ft(this.canvas)}addRelations(){if(this.commit.directparent!=null){var t;this.commit.getLane()==this.commit.directparent.getLane()||this.commit.directparent.outOfScope?t=new mt(this.canvas).from(this.commit.directparent.view.dot).to(this.dot).color(this.commit.getColor(20)):t=new dt(this.canvas).from(this.commit.directparent.view.dot).to(this.dot).color(this.commit.getColor(30)),this.lines.push(t)}var e=this.commit.merges.standard.concat(this.commit.merges.anonymous);e.forEach(i=>{this.lines.push(new ut(this.canvas).from(i.source.view.dot).to(this.dot).color(i.source.getColor(35)))})}redraw(){this.dot.at(this.commit.getX(),this.commit.getY()).size(this.config.dotWidth,this.config.dotHeight).color(this.commit.getColor(20),this.commit.getColor(80))}}class j{static extend(t){var e=t;return t.classList.add("gitline-expandable"),e.whenFull=i=>{e.onclick=()=>{e.innerHTML=i,t.classList.add("gitline-expandable-expanded"),j.selectElementText(t)}},e.whenShort=i=>{e.innerHTML=i,e.onmouseout=()=>{window.setTimeout(()=>{e.innerHTML=i,t.classList.remove("gitline-expandable-expanded")},1e3)}},e}static selectElementText(t){var e=window.document,i,n;window.getSelection&&e.createRange?(i=window.getSelection(),n=e.createRange(),n.selectNodeContents(t),i.removeAllRanges(),i.addRange(n)):e.body.createTextRange&&(n=e.body.createTextRange(),n.moveToElementText(t),n.select())}}class it{constructor(t){s(this,"url");s(this,"callback");s(this,"errorCallback");this.url=t}whenDone(t){this.callback(t)}withErrorCallback(t){this.errorCallback=t}withCallback(t){this.callback=t}onRequested(t){throw new Error("onRequested not implemented on "+this)}request(){this.onRequested(this.url)}error(t){this.errorCallback(t)}}class gt extends it{constructor(e,i,n){super(e);s(this,"forks",[]);s(this,"baseBranches",[]);s(this,"data",{});s(this,"limit");s(this,"accessToken");s(this,"fetchGithubJson",e=>fetch(e,{headers:{...this.accessToken&&{Authorization:`token ${this.accessToken}`},Accept:"application/vnd.github.v3+json"}}).then(i=>{if(i.ok)return i.json();throw new Error("Response wasn't OK when fetching JSON")}));this.accessToken=n,this.limit=i}gitURL(e,i,n=""){return e.indexOf("api.github.com")==-1&&(e=e.replace(/.*github.com/,"https://api.github.com/repos/").replace(/\/\//g,"/")),e+"/"+i+"?per_page="+this.limit+"&"+n}onRequested(e){this.loadForks(e)}loadForks(e){this.fetchGithubJson(this.gitURL(e,"forks")).then(i=>{this.fetchGithubJson(this.gitURL(e,"branches")).then(n=>{this.processBranches(e,n),this.forks=i,this.loadBranches()})}).catch(i=>{this.error("Github API: "+i)})}processBranches(e,i){i.forEach(n=>{n.repo=e.url!==void 0?e.url:e,e.full_name!==void 0&&(n.name=n.name+"@"+e.full_name),this.baseBranches.push(n)})}loadBranches(){var e=this.forks.map(i=>this.fetchGithubJson(this.gitURL(i.url,"branches")).then(n=>{console.debug("loaded branches for "+i.name),this.processBranches(i,n)}));Promise.all(e).then(()=>{console.debug("all branches loaded"),this.loadCommits()})}loadCommits(){var e=[];this.baseBranches.forEach(i=>{var n=this.data[i.commit.sha];n==null&&e.push(this.fetchGithubJson(this.gitURL(i.repo,"commits","sha="+i.commit.sha)).then(m=>{console.debug("loaded commits for "+i.name),this.processCommits(m)}))}),Promise.all(e).then(()=>{this.process()})}processCommits(e){e.map(i=>{var n={};return n.sha=i.sha,n.ssha=i.sha.substring(0,8),n.parenthashes=i.parents.map(m=>m.sha),n.authorname=i.commit.author.name,n.authoremail=i.commit.author.email,n.authordate=new Date(i.commit.author.date).valueOf()/1e3,n.authortimestamp=new Date(i.commit.author.date).valueOf(),n.committername=i.commit.committer.name,n.committeremail=i.commit.committer.email,n.committerdate=new Date(i.commit.committer.date).valueOf()/1e3,n.committertimestamp=new Date(i.commit.committer.date).valueOf(),n.subject=i.commit.message,n.body="",n.refnames=[],n.inHeads=[],n}).forEach(i=>{this.data[i.sha]=i})}process(){this.baseBranches.forEach(i=>{var n=this.data[i.commit.sha];n==null||(i.assigned=!0,n.refnames.push(i.name),this.assignHeads(n))});var e={};Object.keys(this.data).sort((i,n)=>this.data[n].committertimestamp-this.data[i].committertimestamp).forEach(i=>{e[i]=this.data[i]}),this.whenDone(e)}assignHeads(e){for(e.parents1=e.parenthashes.map(n=>n);e.parents1.length>0;){var i=[];e.parents1.forEach(n=>{var m=this.data[n];m!=null&&(m.inHeads.push(e.sha),m.parenthashes.forEach(C=>{i.indexOf(C)===-1&&i.push(C)}))}),e.parents1=i}}}class vt extends it{constructor(){super(...arguments);s(this,"onRequested",e=>fetch(e,{headers:{"Content-Type":"application/json",Accept:"application/json"}}).then(i=>{if(i.ok)return i.json();throw new Error("Response wasn't OK when fetching JSON")}).then(i=>{this.whenDone(i)}).catch(()=>{this.error("Error loading git data from "+e+" create it using git2json")}))}}class K{constructor(){s(this,"maxX",0);s(this,"maxIndexY",0);s(this,"commits",{});s(this,"firstCommit");s(this,"canvas");s(this,"data");s(this,"panel");s(this,"textPanel");s(this,"headsMap",{});s(this,"rootLabel");s(this,"al");s(this,"config",new lt);s(this,"loadingPanel");s(this,"graphicalPanel");s(this,"headerPanel");s(this,"contentPanel");s(this,"commitProvider")}static create(){return new K}addCommit(t){this.commits[t.getFullSha()]=t,this.firstCommit===void 0&&(this.firstCommit=t)}addBranch(t,e,i){this.headsMap[t]=new H(t,e,i)}render(){this.canvas=new jsgl.Panel(this.graphicalPanel),this.al.thenSingle("Loading Data",()=>{this.al.suspend(),this.commitProvider.withCallback(t=>{this.data=t,this.al.resume()}),this.commitProvider.withErrorCallback(t=>{this.al.error(t)}),this.commitProvider.request()}).then("Loading Commits",()=>Object.keys(this.data),t=>{var e=new $(this,this.data[t]);this.addCommit(e)}).thenSingle("Building Graph",()=>{this.buildGraph()}).then("Drawing Labels",()=>Object.keys(this.commits),t=>{var e=this.commits[t];this.drawCommit(e)}).thenSingle("Creating Legend",()=>{this.rootLabel=document.createElement("div"),this.rootLabel.className="commit-legend",this.textPanel.appendChild(this.rootLabel)}).then("Drawing Merges",()=>Object.keys(this.commits),t=>{var e=this.commits[t];this.drawReferences(e)}).thenSingle("Resizing",()=>{this.graphicalPanel.style.width=X(this.maxX+1)+"px",this.graphicalPanel.style.height=this.getHeight()+"px"}).start(),window.onresize=()=>{this.al.then("Redrawing",()=>Object.keys(this.commits),t=>{var e=this.commits[t];e.view.redraw()}).thenSingle("Resizing",()=>{this.graphicalPanel.style.width=X(this.maxX+1)+"px",this.graphicalPanel.style.height=this.getHeight()+"px"}).start(!1)}}getHeight(){return this.rootLabel.offsetTop-this.firstCommit.view.label.offsetTop}buildGraph(){var t=Object.keys(this.commits);t.forEach(e=>{var i=this.commits[e];i.initRelations()}),t.forEach(e=>{var i=this.commits[e];i.initHeadSpecifity(),i.initMerges()}),this.initBranches()}drawCommit(t){t.view=new pt(this.canvas,this.config,t),t.outOfScope===!1&&(t.view.label=this.drawLabel(t),t.view.label.onclick=function(){console&&console.debug(t)},this.textPanel.appendChild(t.view.label),t.view.label.style["padding-left"]=X(this.maxX+1)+"px")}drawReferences(t){t.view.addRelations(),t.view.redraw()}drawLabel(t){var e=document.createElement("gitline-legend"),i=t.getShortSha().trim(),n=t.getFullSha().trim(),m=j.extend(document.createElement("gitline-sha"));if(m.setAttribute("title",n),m.whenShort(i),m.whenFull(n),e.appendChild(m),e.appendChild(this.drawIdentity("author",t.author)),t.author.email!=t.committer.email&&e.appendChild(this.drawIdentity("committer",t.committer)),t.branch&&t.branch.commit===t&&!t.branch.anonymous){var C=j.extend(document.createElement("gitline-ref"));C.style.backgroundColor=t.getColor(40),C.whenShort(t.branch.ref),C.whenFull(t.branch.ref),e.appendChild(C)}var S=document.createElement("gitline-subject");return S.innerHTML=t.subject,t.hasMerges()&&S.classList.add("has-merges"),e.appendChild(S),e}drawIdentity(t,e){var i=document.createElement("gitline-identity-container"),n=j.extend(document.createElement("gitline-identity"));n.classList.add(t);var m=e.name+" &lt;"+e.email.toLowerCase()+"&gt;";n.setAttribute("title",e.name+" <"+e.email.toLowerCase()+">"),n.style.background=this.config.avatars.map(D=>"url("+D(e.email)+") no-repeat left center").join(", "),n.whenFull(m),n.whenShort("");var C=j.extend(document.createElement("gitline-identity-datetime"));C.classList.add(t+"-datetime");var S=e.date.toISOString().slice(0,16).replace("T"," ");return C.setAttribute("title",S),C.whenFull(S),C.whenShort(e.date.toISOString().slice(11,16)),i.appendChild(n),i.appendChild(C),i}initBranches(){for(var t=Object.keys(this.headsMap),e=0;e<t.length;e++){var i=t[e],n=this.headsMap[i];n.commit.initDefaultBranch()}var m=this;t.sort(function(P,_){var f=m.headsMap[P].commit,p=m.headsMap[_].commit;return f===p?0:f.branch.category===p.branch.category?f.branch.specifity-p.branch.specifity:f.branch.category.length-p.branch.category.length});for(var C=0,e=0;e<t.length;e++){var i=t[e],n=this.headsMap[i],S=n.commit;if(S.branch===n){n.lane=C,C++;for(var D=0;D<t.length;D++){for(var l=!0,k=0;k<t.length;k++){var x=t[k],b=this.headsMap[x].commit;(b===void 0||b.branch!=n&&b.branch.lane===D&&(S.intersects(b)||S.branch.category!=b.branch.category))&&(l=!1)}if(l){console.debug("NO INTERSECTS: ",S.branch.ref," - ",b.branch.ref),n.lane=D;break}}this.maxX=Math.max(this.maxX,n.lane)}}}fromJSON(t){return this.fromProvider(new vt(t))}fromGitHub(t,e,i){return this.fromProvider(new gt(t,e,i))}fromProvider(t){return this.commitProvider=t,this}renderTo(t){return this.headerPanel!==void 0&&t.appendChild(this.headerPanel),t.appendChild(this.loadingPanel=document.createElement("gitline-loadingpanel")),t.appendChild(this.contentPanel=document.createElement("gitline-contentpanel")),this.contentPanel.appendChild(this.graphicalPanel=document.createElement("gitline-graphicalpanel")),this.contentPanel.appendChild(this.textPanel=document.createElement("gitline-textpanel")),this.al=new L(this.loadingPanel),this.render(),this}withHeader(t){return typeof t=="string"?(this.headerPanel=document.createElement("gitline-headerpanel"),this.headerPanel.innerHTML=t):this.headerPanel=t,this}}return K});
